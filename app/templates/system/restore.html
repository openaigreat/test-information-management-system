{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mb-4">数据恢复</h1>
    
    <div class="alert alert-warning mb-4" role="alert">
        <h4 class="alert-heading">注意！</h4>
        <p>数据恢复操作将覆盖当前数据库中的所有数据，请谨慎操作。建议在恢复前先备份当前数据。</p>
        <hr>
        <p class="mb-0">强烈建议在测试环境中先进行恢复测试，确认无误后再在生产环境中执行。</p>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">恢复信息</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">上次恢复时间</label>
                        <input type="text" class="form-control" value="2023-10-01 10:15:30" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">恢复状态</label>
                        <input type="text" class="form-control" value="成功" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">恢复文件</label>
                        <input type="text" class="form-control" value="/backups/system_backup_20231001.sql" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">恢复前备份</label>
                        <input type="text" class="form-control" value="/backups/pre_restore_backup_20231001.sql" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">选择备份文件</h5>
            <form>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="backupFile" class="form-label">备份文件</label>
                            <select class="form-select" id="backupFile">
                                <option value="">-- 请选择备份文件 --</option>
                                <option value="/backups/system_backup_20231004.sql">system_backup_20231004.sql (2023-10-04 15:30:22)</option>
                                <option value="/backups/system_backup_20231003.sql">system_backup_20231003.sql (2023-10-03 15:30:22)</option>
                                <option value="/backups/system_backup_20231002.sql">system_backup_20231002.sql (2023-10-02 15:30:22)</option>
                                <option value="/backups/system_backup_20231001.sql">system_backup_20231001.sql (2023-10-01 15:30:22)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="customFile" class="form-label">或上传备份文件</label>
                            <input type="file" class="form-control" id="customFile">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="restoreType" class="form-label">恢复类型</label>
                            <select class="form-select" id="restoreType">
                                <option value="full" selected>完整恢复</option>
                                <option value="data">仅数据恢复</option>
                                <option value="structure">仅结构恢复</option>
                                <option value="partial">部分恢复</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="restoreTables" class="form-label">恢复表（部分恢复时使用）</label>
                            <select class="form-select" id="restoreTables" multiple>
                                <option value="users">用户表</option>
                                <option value="roles">角色表</option>
                                <option value="permissions">权限表</option>
                                <option value="system_settings">系统设置表</option>
                                <option value="logs">日志表</option>
                            </select>
                            <div class="form-text">按住Ctrl键可选择多个表</div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="backupBeforeRestore" checked>
                        <label class="form-check-label" for="backupBeforeRestore">
                            恢复前先备份当前数据
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clearData">
                        <label class="form-check-label" for="clearData">
                            恢复前清空现有数据
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="skipErrors">
                        <label class="form-check-label" for="skipErrors">
                            跳过错误继续恢复
                        </label>
                    </div>
                </div>
                <button type="button" class="btn btn-danger" id="startRestore">开始恢复</button>
            </form>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">恢复进度</h5>
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="restoreProgress">0%</div>
            </div>
            <div class="mb-3">
                <label class="form-label">恢复状态</label>
                <input type="text" class="form-control" value="等待开始" readonly id="restoreStatus">
            </div>
            <div class="mb-3">
                <label class="form-label">恢复日志</label>
                <textarea class="form-control" rows="5" readonly id="restoreLog"></textarea>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">恢复历史</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>恢复ID</th>
                            <th>恢复时间</th>
                            <th>恢复文件</th>
                            <th>恢复类型</th>
                            <th>操作用户</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>2023-10-01 10:15:30</td>
                            <td>system_backup_20231001.sql</td>
                            <td>完整恢复</td>
                            <td>admin</td>
                            <td><span class="badge bg-success">成功</span></td>
                            <td>
                                <button class="btn btn-sm btn-info">查看详情</button>
                            </td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>2023-09-25 14:22:18</td>
                            <td>system_backup_20230925.sql</td>
                            <td>完整恢复</td>
                            <td>admin</td>
                            <td><span class="badge bg-success">成功</span></td>
                            <td>
                                <button class="btn btn-sm btn-info">查看详情</button>
                            </td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>2023-09-20 09:45:33</td>
                            <td>system_backup_20230920.sql</td>
                            <td>部分恢复</td>
                            <td>admin</td>
                            <td><span class="badge bg-warning">部分成功</span></td>
                            <td>
                                <button class="btn btn-sm btn-info">查看详情</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">上一页</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">下一页</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    
    <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('system.index') }}" class="btn btn-secondary">返回系统设置</a>
        <div>
            <button class="btn btn-warning">恢复设置</button>
        </div>
    </div>
</div>

<script>
document.getElementById('startRestore').addEventListener('click', function() {
    // 确认对话框
    if (!confirm('确定要开始数据恢复吗？此操作将覆盖当前数据库中的所有数据。')) {
        return;
    }
    
    // 模拟恢复进度
    let progress = 0;
    const progressBar = document.getElementById('restoreProgress');
    const statusInput = document.getElementById('restoreStatus');
    const logTextarea = document.getElementById('restoreLog');
    
    statusInput.value = '恢复中...';
    logTextarea.value = '开始恢复...\n';
    logTextarea.value += '正在创建恢复前备份...\n';
    logTextarea.scrollTop = logTextarea.scrollHeight;
    
    setTimeout(function() {
        logTextarea.value += '恢复前备份创建完成\n';
        logTextarea.scrollTop = logTextarea.scrollHeight;
        
        const interval = setInterval(function() {
            progress += 5;
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = progress + '%';
            
            logTextarea.value += '恢复进度: ' + progress + '%\n';
            logTextarea.scrollTop = logTextarea.scrollHeight;
            
            if (progress >= 100) {
                clearInterval(interval);
                statusInput.value = '恢复完成';
                logTextarea.value += '数据恢复完成！\n';
                logTextarea.value += '系统将在5秒后重启...\n';
                logTextarea.scrollTop = logTextarea.scrollHeight;
                
                setTimeout(function() {
                    alert('数据恢复完成，系统已重启！');
                }, 5000);
            }
        }, 500);
    }, 2000);
});
</script>
{% endblock %}